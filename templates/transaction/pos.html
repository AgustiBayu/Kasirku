{{ define "title" }}Point of Sale{{ end }}
{{ define "content" }}
<style>
    /* Gaya spesifik untuk halaman POS */
    body { font-family: Arial, sans-serif; display: flex; margin: 0; background-color: #f4f4f4; }
    #left-panel { flex: 1; padding: 20px; }
    #right-panel { flex: 1; padding: 20px; background-color: #fff; border-left: 1px solid #ccc; display: flex; flex-direction: column; }
    #product-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }
    .product-card { border: 1px solid #ddd; padding: 10px; text-align: center; cursor: pointer; background-color: #fff; }
    .product-card:hover { background-color: #e9e9e9; }
    #cart-items { width: 100%; border-collapse: collapse; margin-top: 20px; }
    #cart-items th, #cart-items td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    #cart-items th { background-color: #f2f2f2; }
    .summary { margin-top: auto; padding-top: 20px; border-top: 1px solid #ccc; }
    .summary div { display: flex; justify-content: space-between; padding: 5px 0; }
    #pay-button { width: 100%; padding: 15px; background-color: #28a745; color: white; border: none; font-size: 1.2em; cursor: pointer; margin-top: 10px; }
    #pay-button:disabled { background-color: #aaa; }
</style>

<div id="left-panel">
    <h2>Products</h2>
    <input type="text" id="product-search" placeholder="Search products..." style="width: 100%; padding: 8px; margin-bottom: 10px;">
    <input type="text" id="barcode-scanner-input" placeholder="Scan barcode..." style="width: 100%; padding: 8px; margin-bottom: 10px;">
    
    <!-- Low Stock Alert Panel -->
    <div id="low-stock-alert-panel" style="margin-bottom: 10px; border: 1px solid #ffc107; background-color: #fff3cd; padding: 10px; border-radius: 5px; display: none;">
        <h4 style="margin-top: 0; margin-bottom: 5px; color: #856404;">Peringatan Stok Menipis (<= 5)</h4>
        <ul id="low-stock-list" style="color: #856404; padding-left: 20px; margin-bottom: 0;">
            <!-- Low stock items will be injected here by JS -->
        </ul>
    </div>

    <div id="product-list"></div>
</div>

<div id="right-panel">
    <h2>Cart</h2>
    <table id="cart-items">
        <thead>
            <tr>
                <th>Product</th>
                <th>Price</th>
                <th>Qty</th>
                <th>Subtotal</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <div class="summary">
        <div>
            <strong>Total:</strong>
            <span id="total-amount">0</span>
        </div>
        <div>
            <label for="payment-method">Payment Method:</label>
            <select id="payment-method">
                <option value="Cash">Cash</option>
                <option value="Card">Qris</option>
            </select>
        </div>
        <div>
            <label for="amount-paid">Amount Paid:</label>
            <input type="number" id="amount-paid" value="0">
        </div>
        <div>
            <strong>Change:</strong>
            <span id="change-amount">0</span>
        </div>
    </div>

    <button id="pay-button" disabled>Pay</button>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const productListEl = document.getElementById('product-list');
        const productSearchEl = document.getElementById('product-search');
        const barcodeScannerInputEl = document.getElementById('barcode-scanner-input');
        const cartItemsEl = document.querySelector('#cart-items tbody');
        const totalAmountEl = document.getElementById('total-amount');
        const amountPaidEl = document.getElementById('amount-paid');
        const changeAmountEl = document.getElementById('change-amount');
        const payButton = document.getElementById('pay-button');
        const paymentMethodEl = document.getElementById('payment-method');
        const lowStockListEl = document.getElementById('low-stock-list');

        let products = [];
        let cart = {}; // { productId: { name, price, quantity } }

        // Fetch products from the API
        async function fetchProducts() {
            try {
                const response = await fetch('/api/products');
                const result = await response.json();
                if (result.code === 200) {
                    products = result.data || [];
                    renderProducts();
                } else {
                    alert('Error fetching products: ' + result.message);
                }
            } catch (error) {
                console.error('Fetch error:', error);
                alert('Could not connect to the server to fetch products.');
            }
        }

        // Render products to the list
        function renderProducts(filters = {}) {
            productListEl.innerHTML = '';
            let filteredProducts = products;

            if (filters.name) {
                filteredProducts = products.filter(p => p.name.toLowerCase().includes(filters.name.toLowerCase()));
            } else if (filters.barcode) {
                filteredProducts = products.filter(p => p.barcode && p.barcode.toLowerCase().includes(filters.barcode.toLowerCase()));
            }
            
            filteredProducts.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.textContent = `${product.name} (Rp ${product.price})`;
                card.dataset.productId = product.id;
                card.addEventListener('click', () => addToCart(product.id));
                productListEl.appendChild(card);
            });
        }

        // Add a product to the cart
        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) {
                alert('Product not found in local list. It might need a refresh.');
                return;
            }

            if (cart[productId]) {
                cart[productId].quantity++;
            } else {
                // Sanitize price to ensure it's a number for calculations
                const price = typeof product.price === 'string'
                    ? parseFloat(product.price.replace(/\./g, '').replace(',', '.'))
                    : product.price;

                if (isNaN(price)) {
                    alert(`Invalid price for product: ${product.name}`);
                    return;
                }
                
                cart[productId] = {
                    name: product.name,
                    price: price,
                    quantity: 1
                };
            }
            renderCart();
        }

        // Render the cart table and summary
        function renderCart() {
            cartItemsEl.innerHTML = '';
            let total = 0;

            for (const productId in cart) {
                const item = cart[productId];
                const subtotal = item.price * item.quantity;
                total += subtotal;

                const row = cartItemsEl.insertRow();
                row.insertCell().textContent = item.name;
                row.insertCell().textContent = item.price;
                row.insertCell().textContent = item.quantity;
                row.insertCell().textContent = subtotal;

                const actionCell = row.insertCell();
                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'Remove';
                removeBtn.onclick = () => removeFromCart(productId); // Safer event handling
                actionCell.appendChild(removeBtn);
            }

            totalAmountEl.textContent = total;
            updateChange();
            payButton.disabled = Object.keys(cart).length === 0;
        }

        // Remove item from cart
        function removeFromCart(productId) {
            if (cart[productId]) {
                delete cart[productId];
                renderCart();
            }
        }

        // Update change amount
        function updateChange() {
            const total = parseFloat(totalAmountEl.textContent) || 0;
            const paid = parseFloat(amountPaidEl.value) || 0;
            const change = paid - total;
            changeAmountEl.textContent = change >= 0 ? change : 0;
        }

        // Handle barcode scan
        async function handleBarcodeScan(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const barcode = barcodeScannerInputEl.value.trim();
                if (barcode === '') return;

                try {
                    const response = await fetch(`/api/products/barcode/${barcode}`);
                    const result = await response.json();

                    if (result.code === 200 && result.data) {
                        const scannedProduct = result.data;
                        // Ensure the product is in the local 'products' array
                        if (!products.find(p => p.id === scannedProduct.id)) {
                            products.push(scannedProduct);
                        }
                        addToCart(scannedProduct.id);
                    } else {
                        alert('Product with this barcode not found.');
                    }
                } catch (error) {
                    console.error('Barcode scan fetch error:', error);
                    alert('Error looking up barcode.');
                } finally {
                    barcodeScannerInputEl.value = ''; // Clear input for next scan
                }
            }
        }

        // Print receipt
        function printReceipt(details) {
            const receiptContent = `
                <html>
                <head>
                    <title>Receipt</title>
                    <style>
                        body { font-family: 'Courier New', Courier, monospace; width: 300px; margin: 0 auto; font-size: 12px; }
                        h2 { text-align: center; margin-bottom: 5px; }
                        p { margin: 2px 0; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { padding: 2px; }
                        .text-center { text-align: center; }
                        .text-right { text-align: right; }
                        hr { border: none; border-top: 1px dashed #000; }
                    </style>
                </head>
                <body>
                    <h2 class="text-center">Kasirku</h2>
                    <p class="text-center">Jl. Sayu Wiwit G.05 RT.009/Rw.009 Kec.Muncar Kota</p>
                    <hr>
                    <p>Date: ${new Date().toLocaleString('id-ID')}</p>
                    ${details.transactionId ? `<p>Receipt No: ${details.transactionId}</p>` : ''}
                    <hr>
                    <table>
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Qty</th>
                                <th class="text-right">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.values(details.cart).map(item => `
                                <tr>
                                    <td>${item.name}</td>
                                    <td class="text-center">${item.quantity}</td>
                                    <td class="text-right">${(item.price * item.quantity).toLocaleString('id-ID')}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <hr>
                    <p><strong>Total:</strong> <span style="float: right;">${details.total.toLocaleString('id-ID')}</span></p>
                    <p><strong>Paid:</strong> <span style="float: right;">${details.paid.toLocaleString('id-ID')}</span></p>
                    <p><strong>Change:</strong> <span style="float: right;">${details.change.toLocaleString('id-ID')}</span></p>
                    <p><strong>Payment:</strong> <span style="float: right;">${details.paymentMethod}</span></p>
                    <hr>
                    <p class="text-center">Thank you!</p>
                </body>
                </html>
            `;

            const receiptWindow = window.open('', 'PRINT', 'height=600,width=400');
            receiptWindow.document.write(receiptContent);
            receiptWindow.document.close();
            receiptWindow.focus();
            
            setTimeout(() => {
                receiptWindow.print();
                receiptWindow.close();
            }, 250);
        }

        // Handle payment
        async function handlePayment() {
            const total = parseFloat(totalAmountEl.textContent);
            const paid = parseFloat(amountPaidEl.value);

            if (paid < total) {
                alert('Insufficient payment!');
                return;
            }

            const transactionData = {
                items: Object.keys(cart).map(id => ({
                    product_id: parseInt(id),
                    quantity: cart[id].quantity
                })),
                payment_method: paymentMethodEl.value,
                amount_paid: paid
            };

            payButton.disabled = true;
            payButton.textContent = 'Processing...';

            try {
                const response = await fetch('/transactions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(transactionData)
                });

                const result = await response.json();

                if (response.ok) {
                    const receiptDetails = {
                        transactionId: result.data.id, // Assuming the ID is in the response
                        cart: cart,
                        total: total,
                        paid: paid,
                        change: result.data.change,
                        paymentMethod: paymentMethodEl.value
                    };
                    printReceipt(receiptDetails);

                    // Reset cart
                    cart = {};
                    amountPaidEl.value = 0;
                    renderCart();
                } else {
                    if (result && result.message && result.message.includes("Insufficient stock")) {
                        alert("Error: " + result.message);
                    } else {
                        alert('Transaction failed: ' + (result.message || 'Unknown error'));
                    }
                }
            } catch (error) {
                console.error('Payment error:', error);
                alert('Could not process the transaction.');
            } finally {
                payButton.disabled = false;
                payButton.textContent = 'Pay';
            }
        }

        // Event Listeners
        productSearchEl.addEventListener('input', (e) => {
            barcodeScannerInputEl.value = '';
            renderProducts({ name: e.target.value });
        });
        barcodeScannerInputEl.addEventListener('input', (e) => {
            productSearchEl.value = '';
            renderProducts({ barcode: e.target.value });
        });
        barcodeScannerInputEl.addEventListener('keypress', handleBarcodeScan);
        amountPaidEl.addEventListener('input', updateChange);
        payButton.addEventListener('click', handlePayment);

        // Initial fetch
        fetchProducts();
        fetchLowStockProducts();
    });

    // Fetch and display low stock products
    async function fetchLowStockProducts() {
        const lowStockPanelEl = document.getElementById('low-stock-alert-panel');
        const lowStockListEl = document.getElementById('low-stock-list');
        try {
            const response = await fetch('/api/products/low-stock?threshold=5');
            const result = await response.json();
            
            lowStockListEl.innerHTML = ''; // Clear previous list

            if (result.code === 200 && result.data && result.data.length > 0) {
                lowStockPanelEl.style.display = 'block'; // Show the panel
                result.data.forEach(product => {
                    const listItem = document.createElement('li');
                    listItem.textContent = `${product.name} - Sisa: ${product.stock}`;
                    lowStockListEl.appendChild(listItem);
                });
            } else {
                lowStockPanelEl.style.display = 'none'; // Keep panel hidden
            }
        } catch (error) {
            console.error('Error fetching low stock products:', error);
            lowStockPanelEl.style.display = 'none'; // Keep panel hidden on error
        }
    }
</script>
{{ end }}