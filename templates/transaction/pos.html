{{ define "title" }}Point of Sale{{ end }}
{{ define "content" }}
<style>
    /* General body styling */
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        display: flex;
        margin: 0;
        background-color: #f0f2f5;
        color: #333;
    }

    /* Left and right panels */
    #left-panel, #right-panel {
        flex: 1;
        padding: 20px;
        box-sizing: border-box;
    }

    #left-panel {
        background-color: #fff;
        border-right: 1px solid #e0e0e0;
    }

    #right-panel {
        background-color: #f8f9fa;
        display: flex;
        flex-direction: column;
    }

    /* Product list styling */
    #product-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 20px;
        max-height: 70vh;
        overflow-y: auto;
        padding-right: 10px;
    }

    /* Product card styling */
    .product-card {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
        cursor: pointer;
        background-color: #fff;
        transition: transform 0.2s, box-shadow 0.2s;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .product-card img {
        max-width: 100%;
        height: 100px;
        object-fit: cover;
        border-radius: 4px;
        margin-bottom: 10px;
    }

    .product-card .product-name {
        font-weight: 600;
        font-size: 0.95em;
        margin-bottom: 5px;
    }

    .product-card .product-price {
        color: #007bff;
        font-weight: bold;
    }

    /* Cart styling */
    #cart-items {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    #cart-items th, #cart-items td {
        border-bottom: 1px solid #e0e0e0;
        padding: 12px 8px;
        text-align: left;
    }

    #cart-items th {
        background-color: #f2f2f2;
        font-weight: 600;
    }

    /* Summary section */
    .summary {
        margin-top: auto;
        padding-top: 20px;
        border-top: 2px solid #e0e0e0;
    }

    .summary div {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        font-size: 1.1em;
    }

    /* Pay button */
    #pay-button {
        width: 100%;
        padding: 15px;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 1.2em;
        cursor: pointer;
        margin-top: 10px;
        transition: background-color 0.2s;
    }

    #pay-button:disabled {
        background-color: #aaa;
        cursor: not-allowed;
    }
    #pay-button:hover:not(:disabled) {
        background-color: #218838;
    }

    /* Search and barcode inputs */
    #product-search, #barcode-scanner-input {
        width: 100%;
        padding: 12px;
        margin-bottom: 15px;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-sizing: border-box;
    }

</style>

<div id="left-panel">
    <h2>Products</h2>
    <input type="text" id="product-search" placeholder="Search products...">
    <input type="text" id="barcode-scanner-input" placeholder="Scan barcode...">    

    <div id="low-stock-alert-panel" style="margin-bottom: 10px; border: 1px solid #ffc107; background-color: #fff3cd; padding: 10px; border-radius: 5px; display: none;">
        <h4 style="margin-top: 0; margin-bottom: 5px; color: #856404;">Peringatan Stok Menipis (<= 5)</h4>
        <ul id="low-stock-list" style="color: #856404; padding-left: 20px; margin-bottom: 0;">
            <!-- Low stock items will be injected here by JS -->
        </ul>
    </div>
    <div id="product-list"></div>
</div>

<div id="right-panel">
    <h2>Cart</h2>
    <table id="cart-items">
        <thead>
            <tr>
                <th>Product</th>
                <th>Price</th>
                <th>Qty</th>
                <th>Subtotal</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <div class="summary">
        <div>
            <strong>Total:</strong>
            <span id="total-amount">0</span>
        </div>
        <div>
            <label for="payment-method">Payment Method:</label>
            <select id="payment-method">
                <option value="Cash">Cash</option>
                <option value="Card">Qris</option>
            </select>
        </div>
        <div>
            <label for="amount-paid">Amount Paid:</label>
            <input type="number" id="amount-paid" value="0">
        </div>
        <div>
            <strong>Change:</strong>
            <span id="change-amount">0</span>
        </div>
    </div>

    <button id="pay-button" disabled>Pay</button>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const productListEl = document.getElementById('product-list');
        const productSearchEl = document.getElementById('product-search');
        const barcodeScannerInputEl = document.getElementById('barcode-scanner-input');
        const cartItemsEl = document.querySelector('#cart-items tbody');
        const totalAmountEl = document.getElementById('total-amount');
        const amountPaidEl = document.getElementById('amount-paid');
        const changeAmountEl = document.getElementById('change-amount');
        const payButton = document.getElementById('pay-button');
        const paymentMethodEl = document.getElementById('payment-method');
        const lowStockListEl = document.getElementById('low-stock-list');

        let products = [];
        let cart = {};

        async function fetchProducts() {
            try {
                const response = await fetch('/api/products');
                const result = await response.json();
                if (result.code === 200) {
                    products = result.data || [];
                    renderProducts();
                } else {
                    alert('Error fetching products: ' + result.message);
                }
            } catch (error) {
                console.error('Fetch error:', error);
                alert('Could not connect to the server to fetch products.');
            }
        }

        function renderProducts(filters = {}) {
            productListEl.innerHTML = '';
            let filteredProducts = products;

            if (filters.name) {
                filteredProducts = products.filter(p => p.name.toLowerCase().includes(filters.name.toLowerCase()));
            }

            filteredProducts.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.dataset.productId = product.id;

                const img = document.createElement('img');
                img.src = product.thumbnail ? '/' + product.thumbnail : '/static/images/placeholder.png';
                img.alt = product.name;

                const name = document.createElement('div');
                name.className = 'product-name';
                name.textContent = product.name;

                const price = document.createElement('div');
                price.className = 'product-price';
                price.textContent = `Rp ${product.price}`;

                card.appendChild(img);
                card.appendChild(name);
                card.appendChild(price);

                card.addEventListener('click', () => addToCart(product.id));
                productListEl.appendChild(card);
            });
        }

        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            if (cart[productId]) {
                cart[productId].quantity++;
            } else {
                cart[productId] = {
                    name: product.name,
                    price: product.price,
                    quantity: 1
                };
            }
            renderCart();
        }

        function renderCart() {
            cartItemsEl.innerHTML = '';
            let total = 0;

            for (const productId in cart) {
                const item = cart[productId];
                const subtotal = item.price * item.quantity;
                total += subtotal;

                const row = cartItemsEl.insertRow();
                row.insertCell().textContent = item.name;
                row.insertCell().textContent = item.price;
                row.insertCell().textContent = item.quantity;
                row.insertCell().textContent = subtotal;

                const actionCell = row.insertCell();
                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'Remove';
                removeBtn.onclick = () => removeFromCart(productId);
                actionCell.appendChild(removeBtn);
            }

            totalAmountEl.textContent = total;
            updateChange();
            payButton.disabled = Object.keys(cart).length === 0;
        }

        function removeFromCart(productId) {
            delete cart[productId];
            renderCart();
        }

        function updateChange() {
            const total = parseFloat(totalAmountEl.textContent) || 0;
            const paid = parseFloat(amountPaidEl.value) || 0;
            const change = paid - total;
            changeAmountEl.textContent = change >= 0 ? change : 0;
        }
        
        async function handleBarcodeScan(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const barcode = barcodeScannerInputEl.value.trim();
                if (barcode === '') return;

                try {
                    const response = await fetch(`/api/products/barcode/${barcode}`);
                    const result = await response.json();

                    if (result.code === 200 && result.data) {
                        const scannedProduct = result.data;
                        if (!products.find(p => p.id === scannedProduct.id)) {
                            products.push(scannedProduct);
                        }
                        addToCart(scannedProduct.id);
                    } else {
                        alert('Product with this barcode not found.');
                    }
                } catch (error) {
                    console.error('Barcode scan fetch error:', error);
                    alert('Error looking up barcode.');
                } finally {
                    barcodeScannerInputEl.value = '';
                }
            }
        }

        async function handlePayment() {
            const total = parseFloat(totalAmountEl.textContent);
            const paid = parseFloat(amountPaidEl.value);

            if (paid < total) {
                alert('Insufficient payment!');
                return;
            }

            const transactionData = {
                items: Object.keys(cart).map(id => ({
                    product_id: parseInt(id),
                    quantity: cart[id].quantity
                })),
                payment_method: paymentMethodEl.value,
                amount_paid: paid
            };

            payButton.disabled = true;
            payButton.textContent = 'Processing...';

            try {
                const response = await fetch('/transactions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(transactionData)
                });

                const result = await response.json();

                if (response.ok) {
                    alert('Transaction successful!');
                    cart = {};
                    amountPaidEl.value = 0;
                    renderCart();
                } else {
                    if (result && result.message && result.message.includes("Insufficient stock")) {
                        alert("Error: " + result.message);
                    } else {
                        alert('Transaction failed: ' + (result.message || 'Unknown error'));
                    }
                }
            } catch (error) {
                console.error('Payment error:', error);
                alert('Could not process the transaction.');
            } finally {
                payButton.disabled = false;
                payButton.textContent = 'Pay';
            }
        }

        productSearchEl.addEventListener('input', (e) => renderProducts({ name: e.target.value }));
        barcodeScannerInputEl.addEventListener('keypress', handleBarcodeScan);
        amountPaidEl.addEventListener('input', updateChange);
        payButton.addEventListener('click', handlePayment);

        fetchProducts();
        fetchLowStockProducts();
    });
    async function fetchLowStockProducts() {
        const lowStockPanelEl = document.getElementById('low-stock-alert-panel');
        const lowStockListEl = document.getElementById('low-stock-list');
        try {
            const response = await fetch('/api/products/low-stock?threshold=5');
            const result = await response.json();
            
            lowStockListEl.innerHTML = ''; // Clear previous list

            if (result.code === 200 && result.data && result.data.length > 0) {
                lowStockPanelEl.style.display = 'block'; // Show the panel
                result.data.forEach(product => {
                    const listItem = document.createElement('li');
                    listItem.textContent = `${product.name} Dengan Barcode: ${product.barcode} - Sisa: ${product.stock}`;
                    lowStockListEl.appendChild(listItem);
                });
            } else {
                lowStockPanelEl.style.display = 'none'; // Keep panel hidden
            }
        } catch (error) {
            console.error('Error fetching low stock products:', error);
            lowStockPanelEl.style.display = 'none'; // Keep panel hidden on error
        }
    }
</script>
{{ end }}
